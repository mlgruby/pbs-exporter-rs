name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check
        run: cargo check --all-features

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --all-features

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run audit
        run: cargo audit

  build:
    name: Build Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build release
        run: cargo build --release
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: pbs-exporter-linux-amd64
          path: target/release/pbs-exporter

  docker-build:
    name: Docker Build (${{ matrix.debian }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - debian: "debian:12"
            name: "Debian 12 (Bookworm)"
          - debian: "debian:13"
            name: "Debian 13 (Trixie)"
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: pbs-exporter:test-${{ matrix.debian }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        run: |
          # Start container with test config
          docker run -d --name test-exporter \
            -e PBS_EXPORTER__PBS__ENDPOINT=https://example.com:8007 \
            -e PBS_EXPORTER__PBS__TOKEN_ID=test@pam!token \
            -e PBS_EXPORTER__PBS__TOKEN_SECRET=test-secret \
            -e PBS_EXPORTER__PBS__VERIFY_TLS=false \
            pbs-exporter:test-${{ matrix.debian }} &
          
          # Wait for startup
          sleep 3
          
          # Check if container is running
          docker ps | grep test-exporter
          
          # Verify binary exists and is executable
          docker exec test-exporter /usr/local/bin/pbs-exporter --help
          
          # Cleanup
          docker rm -f test-exporter || true
      
      - name: Check image size
        run: |
          SIZE=$(docker images pbs-exporter:test-${{ matrix.debian }} --format "{{.Size}}")
          echo "Image size for ${{ matrix.name }}: $SIZE"
          
          # Verify image is under 50MB (Alpine-based should be ~23MB)
          SIZE_MB=$(docker images pbs-exporter:test-${{ matrix.debian }} --format "{{.Size}}" | sed 's/MB//')
          if (( $(echo "$SIZE_MB > 50" | bc -l) )); then
            echo "Warning: Image size exceeds 50MB"
          fi
